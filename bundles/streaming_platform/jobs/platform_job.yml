resources:
  jobs:
    streaming_platform_job:
      name: "streaming_platform_${bundle.target}"

      # Optional: prevent overlapping runs in dev/stage
      max_concurrent_runs: 1

      # Job parameters (visible in Databricks UI + overridable per run)
      parameters:
        - name: tenant_id
          default: ${var.tenant_id}
        - name: config_file
          default: ${var.config_file}
        - name: run_minutes
          default: ${var.run_minutes}
        - name: site_id
          default: "site_demo"
        - name: event_type
          default: "temp_humidity.v1"


      job_clusters:
        - job_cluster_key: platform_cluster
          new_cluster:
            spark_version: "16.4.x-scala2.12"
            node_type_id: "Standard_D4ds_v4"
            num_workers: 1
            autotermination_minutes: 20
            data_security_mode: "SINGLE_USER"
            single_user_name: "info@justaboutdata.com"

            spark_conf:
              spark.databricks.delta.optimizeWrite.enabled: "true"
              spark.databricks.delta.autoCompact.enabled: "true"

            libraries:
              - maven:
                  coordinates: "com.microsoft.azure:azure-eventhubs-spark_2.12:2.3.22"

      tasks:
        - task_key: bronze
          job_cluster_key: platform_cluster
          libraries:
            - maven:
                coordinates: "com.microsoft.azure:azure-eventhubs-spark_2.12:2.3.22"
          notebook_task:
            notebook_path: "/Users/info@justaboutdata.com/streaming-platform/bronze/bronze_ingestion"
            base_parameters:
              tenant_id: "{{job.parameters.tenant_id}}"
              config_file: "{{job.parameters.config_file}}"
              run_minutes: "{{job.parameters.run_minutes}}"
              site_id: "{{job.parameters.site_id}}"
              event_type: "{{job.parameters.event_type}}"



        - task_key: silver
          depends_on:
            - task_key: bronze
          job_cluster_key: platform_cluster
          libraries:
            - maven:
                coordinates: "com.microsoft.azure:azure-eventhubs-spark_2.12:2.3.22"
          notebook_task:
            notebook_path: "/Users/info@justaboutdata.com/streaming-platform/silver/silver_processing"
            base_parameters:
              tenant_id: "{{job.parameters.tenant_id}}"
              config_file: "{{job.parameters.config_file}}"
              run_minutes: "{{job.parameters.run_minutes}}"
              site_id: "{{job.parameters.site_id}}"
              event_type: "{{job.parameters.event_type}}"


        - task_key: gold
          depends_on:
            - task_key: silver
          job_cluster_key: platform_cluster
          libraries:
            - maven:
                coordinates: "com.microsoft.azure:azure-eventhubs-spark_2.12:2.3.22"
          notebook_task:
            notebook_path: "/Users/info@justaboutdata.com/streaming-platform/gold/gold_serving"
            base_parameters:
              tenant_id: "{{job.parameters.tenant_id}}"
              config_file: "{{job.parameters.config_file}}"
              run_minutes: "{{job.parameters.run_minutes}}"
              site_id: "{{job.parameters.site_id}}"
              event_type: "{{job.parameters.event_type}}"
